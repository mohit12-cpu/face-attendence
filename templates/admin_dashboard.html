{% extends "admin_layout.html" %}

{% block title %}Admin Dashboard - CognAttendance{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
        <p class="text-muted">Manage students and monitor attendance system</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card admin-card text-center">
            <div class="card-body">
                <i class="fas fa-users fa-3x text-primary mb-3"></i>
                <h3 class="card-title">{{ total_students }}</h3>
                <p class="card-text">Total Students</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card admin-card text-center">
            <div class="card-body">
                <i class="fas fa-clipboard-list fa-3x text-success mb-3"></i>
                <h3 class="card-title">{{ total_records }}</h3>
                <p class="card-text">Total Records</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card admin-card text-center">
            <div class="card-body">
                <i class="fas fa-calendar-day fa-3x text-info mb-3"></i>
                <h3 class="card-title">{{ today_records }}</h3>
                <p class="card-text">Today's Records</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card admin-card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('admin_register') }}" class="btn admin-btn text-white mr-2 mb-2">
                    <i class="fas fa-user-plus"></i> Register New Student
                </a>
                <a href="{{ url_for('list_attendance') }}" class="btn btn-outline-primary mr-2 mb-2" target="_blank">
                    <i class="fas fa-list-alt"></i> View Attendance
                </a>
                <a href="{{ url_for('export_attendance') }}" class="btn btn-outline-success mr-2 mb-2" target="_blank">
                    <i class="fas fa-download"></i> Export Data
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Students Management -->
<div class="row">
    <div class="col-12">
        <div class="card admin-card">
            <div class="card-header">
                <h5><i class="fas fa-users-cog"></i> Student Management</h5>
            </div>
            <div class="card-body">
                {% if students %}
                <div class="table-responsive">
                    <table id="studentsTable" class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>Photo</th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Faculty</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr id="student-{{ student.id }}">
                                <td>
                                    <img src="{{ url_for('known_face_image', filename=student.id + '.jpg') }}" 
                                         alt="{{ student.name }}" class="rounded-circle" 
                                         style="width: 40px; height: 40px; object-fit: cover;"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSIjOUM5Qzk3Ii8+CjxwYXRoIGQ9Ik0xMiAxNEM5LjMzIDEzIDcuMzMgMTQuMzMgNiAxNi4zM1YyMEgxOFYxNi4zM0MxNi42NyAxNC4zMyAxNC42NyAxMyAxMiAxNFoiIGZpbGw9IiM5QzlDOTciLz4KPC9zdmc+Cjwvc3ZnPgo='">
                                </td>
                                <td><span class="badge badge-primary">{{ student.id }}</span></td>
                                <td><strong>{{ student.name }}</strong></td>
                                <td>{{ student.faculty or 'N/A' }}</td>
                                <td>{{ student.email or 'N/A' }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('admin_edit_student', student_id=student.id) }}" 
                                           class="btn btn-sm btn-outline-primary" title="Edit Student">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger delete-student" 
                                                data-student-id="{{ student.id }}" 
                                                data-student-name="{{ student.name }}" title="Delete Student">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No students registered yet</h5>
                    <p class="text-muted">Start by registering your first student</p>
                    <a href="{{ url_for('admin_register') }}" class="btn admin-btn text-white">
                        <i class="fas fa-user-plus"></i> Register First Student
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#studentsTable').DataTable({
        "pageLength": 10,
        "order": [[ 2, "asc" ]],
        "columnDefs": [
            { "orderable": false, "targets": [0, 5] }
        ]
    });

    // Delete student functionality
    $('.delete-student').click(function() {
        const studentId = $(this).data('student-id');
        const studentName = $(this).data('student-name');
        
        if (confirm(`Are you sure you want to delete student "${studentName}"? This action cannot be undone.`)) {
            $.ajax({
                url: `/admin/student/${studentId}/delete`,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        $(`#student-${studentId}`).fadeOut(300, function() {
                            $(this).remove();
                            // Check if table is empty
                            if ($('#studentsTable tbody tr:visible').length === 0) {
                                location.reload();
                            }
                        });
                        
                        // Show success message
                        const alertHtml = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                ${response.message}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        `;
                        $('main .container').prepend(alertHtml);
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while deleting the student.');
                }
            });
        }
    });
});
</script>
{% endblock %}
