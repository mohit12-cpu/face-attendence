{% extends 'admin_layout.html' %}

{% block title %}Edit Student - Admin Panel{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card admin-card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-user-edit mr-2"></i> Edit Student: {{ student.name }}</h5>
            </div>
            <div class="card-body">
                <form id="edit-form" method="post" enctype="multipart/form-data" novalidate>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <div class="form-label-group">
                                <input type="text" id="name" name="name" class="form-control" placeholder="Name" value="{{ student.name }}" required>
                                <label for="name">Name</label>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <div class="form-label-group">
                                <input type="text" id="faculty" name="faculty" class="form-control" placeholder="Faculty" value="{{ student.faculty or '' }}">
                                <label for="faculty">Faculty</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                             <div class="form-label-group">
                                <input type="date" id="dob" name="dob" class="form-control" placeholder="Date of Birth" value="{{ student.dob or '' }}">
                                <label for="dob">Date of Birth</label>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <div class="form-label-group">
                                <input type="email" id="email" name="email" class="form-control" placeholder="Email" value="{{ student.email or '' }}">
                                <label for="email">Email</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-label-group">
                            <input type="text" id="address" name="address" class="form-control" placeholder="Address" value="{{ student.address or '' }}">
                            <label for="address">Address</label>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Current Photo Display -->
                    <div class="form-group">
                        <label class="mb-3">Current Photo</label>
                        <div class="text-center mb-3">
                            <img src="{{ url_for('known_face_image', filename=student.id + '.jpg') }}" 
                                 alt="{{ student.name }}" class="img-thumbnail" 
                                 style="max-height: 200px; max-width: 200px;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRTVFN0VCIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOUM5Qzk3Ij5ObyBJbWFnZTwvdGV4dD4KPHN2Zz4K'">
                            <p class="text-muted mt-2">Student ID: <span class="badge badge-primary">{{ student.id }}</span></p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="mb-3">Update Face Image (Optional)</label>
                        <div class="row align-items-center">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <button type="button" class="btn btn-outline-secondary btn-block mb-3" data-toggle="modal" data-target="#cameraModal">
                                    <i class="fas fa-camera mr-2"></i> Capture New Photo
                                </button>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="face_image_file" name="face_image_file" accept="image/*">
                                    <label class="custom-file-label" for="face_image_file">Or choose a new file...</label>
                                </div>
                            </div>
                            <div class="col-md-6 text-center">
                                <img id="preview" class="img-fluid" style="max-height: 180px; border-radius: 8px; display: none; border: 2px solid var(--border-color);"/>
                                <div id="preview-placeholder" class="text-muted">
                                    <i class="fas fa-image fa-3x"></i>
                                    <p>New Image Preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field for captured image data -->
                    <input type="hidden" name="face_image_data" id="face_image_data">

                    <hr class="my-4">

                    <div class="row">
                        <div class="col-md-6">
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary btn-lg btn-block">
                                <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                            </a>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-warning btn-lg btn-block">
                                <i class="fas fa-save mr-2"></i> Update Student
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-camera-retro mr-2"></i> Capture New Photo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <div class="form-group">
                    <label for="camera-select">Select Camera:</label>
                    <select id="camera-select" class="form-control"></select>
                </div>
                <video id="video" width="640" height="480" autoplay playsinline style="border-radius: 8px; background-color: #000;"></video>
                <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" id="snap" class="btn btn-primary"><i class="fas fa-camera"></i> Snap Photo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<style>
    /* Floating Label styles */
    .form-label-group {
        position: relative;
        margin-bottom: 1rem;
    }
    .form-label-group .form-control {
        height: auto;
        padding: 1.2rem 1rem;
    }
    .form-label-group > label {
        position: absolute;
        top: -1.1rem;
        left: .8rem;
        font-size: 0.8rem;
        color: #667eea;
        background: white;
        padding: 0.2rem 0.4rem;
        width: auto;
        margin-bottom: 0;
        line-height: 1.5;
        border: 1px solid transparent;
        border-radius: .25rem;
        transition: all .1s ease-in-out;
        pointer-events: none;
    }
    .form-label-group input:focus ~ label {
        color: #667eea;
    }
</style>
<script>
    (function() {
        'use strict';
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById('snap');
        const imageDataInput = document.getElementById('face_image_data');
        const fileInput = document.getElementById('face_image_file');
        const preview = document.getElementById('preview');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const cameraSelect = document.getElementById('camera-select');
        let currentStream;

        async function getCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                cameraSelect.innerHTML = '';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
            } catch (err) {
                console.error("Error enumerating devices: ", err);
            }
        }

        async function startCamera(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            const constraints = {
                video: { deviceId: deviceId ? { exact: deviceId } : undefined, width: { ideal: 1280 }, height: { ideal: 720 } }
            };
            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access the camera. Please ensure you have given permission and the camera is not in use by another app.");
            }
        }

        $('#cameraModal').on('shown.bs.modal', async function () {
            await getCameras();
            if (cameraSelect.value) {
                startCamera(cameraSelect.value);
            }
        });

        $('#cameraModal').on('hidden.bs.modal', function () {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });

        cameraSelect.addEventListener('change', () => {
            startCamera(cameraSelect.value);
        });

        snap.addEventListener('click', function() {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, 640, 480);
            const dataUrl = canvas.toDataURL('image/jpeg');
            imageDataInput.value = dataUrl;
            preview.src = dataUrl;
            preview.style.display = 'block';
            previewPlaceholder.style.display = 'none';
            fileInput.value = ''; // Clear file input
            $('.custom-file-label').text('Or choose a new file...');
            $('#cameraModal').modal('hide');
        });

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    preview.src = event.target.result;
                    preview.style.display = 'block';
                    previewPlaceholder.style.display = 'none';
                    imageDataInput.value = ''; // Clear captured data
                }
                reader.readAsDataURL(file);
                document.querySelector('.custom-file-label').innerText = file.name;
            }
        });
    })();
</script>
{% endblock %}
