
{% extends 'layout.html' %}

{% block title %}Register New Student{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <i class="fas fa-user-plus"></i> Register New Student
        </div>
        <div class="card-body">
            <form id="register-form" method="post" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="name">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="faculty">Faculty</label>
                        <input type="text" class="form-control" id="faculty" name="faculty">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="dob">Date of Birth</label>
                        <input type="date" class="form-control" id="dob" name="dob">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="address">Address</label>
                    <input type="text" class="form-control" id="address" name="address">
                </div>
                
                <!-- Hidden field for captured image data -->
                <input type="hidden" name="face_image_data" id="face_image_data">

                <div class="form-group">
                    <label>Face Image</label>
                    <div class="d-flex">
                        <button type="button" class="btn btn-secondary mr-3" data-toggle="modal" data-target="#cameraModal">
                            <i class="fas fa-camera"></i> Capture Photo
                        </button>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="face_image_file" name="face_image_file" accept="image/*">
                            <label class="custom-file-label" for="face_image_file">Or choose a file...</label>
                        </div>
                    </div>
                    <img id="preview" class="mt-3" style="max-width: 200px; border-radius: 8px; display: none;"/>
                </div>

                <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Register Student</button>
            </form>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="modal fade" id="cameraModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Capture Photo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <div class="form-group">
                        <label for="camera-select">Select Camera:</label>
                        <select id="camera-select" class="form-control"></select>
                    </div>
                    <video id="video" width="640" height="480" autoplay playsinline></video>
                    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="snap" class="btn btn-primary">Snap Photo</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snap = document.getElementById('snap');
    const imageDataInput = document.getElementById('face_image_data');
    const fileInput = document.getElementById('face_image_file');
    const preview = document.getElementById('preview');
    const cameraSelect = document.getElementById('camera-select');
    let currentStream;

    async function getCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            cameraSelect.innerHTML = '';
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Camera ${index + 1}`;
                cameraSelect.appendChild(option);
            });
        } catch (err) {
            console.error("Error enumerating devices: ", err);
        }
    }

    async function startCamera(deviceId) {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        const constraints = {
            video: { deviceId: deviceId ? { exact: deviceId } : undefined }
        };
        try {
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
        } catch (err) {
            console.error("Error accessing camera: ", err);
            alert("Could not access the camera. Please ensure you have given permission.");
        }
    }

    // Open camera when modal is shown
    $('#cameraModal').on('shown.bs.modal', async function () {
        await getCameras();
        startCamera(cameraSelect.value);
    });

    // Stop camera when modal is hidden
    $('#cameraModal').on('hidden.bs.modal', function () {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
    });

    // Switch camera on selection change
    cameraSelect.addEventListener('change', () => {
        startCamera(cameraSelect.value);
    });

    // Capture photo from video stream
    snap.addEventListener('click', function() {
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, 640, 480);
        const dataUrl = canvas.toDataURL('image/jpeg');
        imageDataInput.value = dataUrl;
        preview.src = dataUrl;
        preview.style.display = 'block';
        fileInput.value = ''; // Clear file input
        $('#cameraModal').modal('hide');
    });

    // Handle file input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                preview.src = event.target.result;
                preview.style.display = 'block';
                imageDataInput.value = ''; // Clear captured data
            }
            reader.readAsDataURL(file);
            document.querySelector('.custom-file-label').innerText = file.name;
        }
    });

    // Ensure at least one image source is provided
    document.getElementById('register-form').addEventListener('submit', function(e) {
        if (!imageDataInput.value && !fileInput.files[0]) {
            e.preventDefault();
            alert('Please capture a photo or select an image file.');
        }
    });
</script>
{% endblock %}
